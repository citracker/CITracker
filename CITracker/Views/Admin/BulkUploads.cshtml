@{
    ViewData["Title"] = "CI Tracker";
    ViewData["Base"] = "Uploads";
    ViewData["Active"] = "BulkManagement";
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

<!--APP-CONTENT START-->
<div class="main-content app-content">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-md-flex d-block align-items-center justify-content-between page-header-breadcrumb">
            <div>
                <h2 class="main-content-title fs-24 mb-1">Perform Bulk Uploads</h2>
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">Administration</a></li>
                    <li class="breadcrumb-item active" aria-current="page">Bulk Uploads</li>
                </ol>
            </div>
        </div>
        <!-- Page Header Close -->
        <!-- Page Header Close -->
        <div id="project_info" class="row row-sm">
        </div>
        <div class="row row-sm">
            <div class="col-xl-12"> 
                <div class="card custom-card"> 
                    <div class="card-header"> 
                        <div class="card-title"> Bulk Location Upload </div> 
                    </div> 
                    <div class="card-body">
                        <div class="row gy-4 mb-5">
                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                                <label for="input-text" class="form-label"> Select Upload Type </label>
                                <select class="form-control" id="uploadtype" onchange="onUploadTypeChanged(this)" required>
                                    <option selected disabled>Select an Upload Type</option>
                                    <option value="1">Users</option>
                                    <option value="2">Operational Location</option>
                                    <option value="3">Operationl Excellence Initiatives</option>
                                    @* <option value="4">Strategic Initiatives</option>
                                    <option value="5">Continuous Improvement Initiatives</option> *@
                                </select>
                            </div>
                            <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                                <div class="text-center d-none upload-template" data-upload="1">
                                    <div class="file-manger-icon"> 
                                        <a href="~/templates/users.xlsx"><img src="~/assets/images/files/png/3.png" alt="img" class="br-7"></a> 
                                    </div> 
                                    <h6 class="mb-1 fw-medium mt-0">User Template</h6>
                                    <span class="text-muted">20MB (max file size)</span>
                                </div>
                                <div class="text-center d-none upload-template" data-upload="2">
                                    <div class="file-manger-icon">
                                        <a href="~/templates/location.xlsx"><img src="~/assets/images/files/png/3.png" alt="img" class="br-7"></a>
                                    </div>
                                    <h6 class="mb-1 fw-medium mt-0">Location Template</h6>
                                    <span class="text-muted">20MB (max file size)</span>
                                </div>
                                <div class="text-center d-none upload-template" data-upload="3">
                                    <div class="file-manger-icon">
                                        <a href="~/templates/operationalexcellence.xlsx"><img src="~/assets/images/files/png/3.png" alt="img" class="br-7"></a>
                                    </div>
                                    <h6 class="mb-1 fw-medium mt-0">Operational Excellence Template</h6>
                                    <span class="text-muted">20MB (max file size)</span>
                                </div>
                            </div>
                        </div>
                        <div class="row gy-4 d-none" id="uploadArea">
                            <div id="validationSummaryPP" class="alert alert-danger d-none" role="alert">
                                <ul class="mb-0"></ul>
                            </div>
                            @Html.AntiForgeryToken()

                            <input type="file" id="excelInput" accept=".xlsx" />

                            <div class="mt-3">
                                <table id="previewTable" class="table table-bordered table-striped w-100">
                                    <thead></thead>
                                    <tbody></tbody>
                                </table>
                            </div>

                            <button id="uploadBtn" class="btn btn-primary mt-3 d-none">
                                Upload
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let extractedRows = [];
    let dataTable = null;

    document.getElementById('excelInput').addEventListener('change', handleExcel);
    document.getElementById('uploadBtn').addEventListener('click', uploadData);


    function handleExcel(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();

        reader.onload = function (evt) {
            const data = new Uint8Array(evt.target.result);
            const workbook = XLSX.read(data, {
                type: 'array',
                cellDates: true
            });

            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(sheet, {
                header: 1,
                raw: true
            });

            if (rows.length < 2) {
                alert("Excel must contain headers and at least one data row");
                return;
            }

            const headers = rows[0];
            const bodyRows = rows.slice(1);

            // Build objects
            const rawData = bodyRows.map(r => {
                const obj = {};
                headers.forEach((h, i) => {
                    const value = r[i];

                    if (value instanceof Date) {
                        // FORCE yyyy-MM-dd
                        const yyyy = value.getFullYear();
                        const mm = String(value.getMonth() + 1).padStart(2, '0');
                        const dd = String(value.getDate()).padStart(2, '0');
                        obj[h] = `${yyyy}-${mm}-${dd}`;
                    } else {
                        obj[h] = (value ?? '').toString().trim();
                    }
                });
                return obj;
            });


            // Remove duplicate rows (ALL columns must match)
            extractedRows = removeDuplicateRows(rawData, headers);

            buildTable(headers, extractedRows);
            document.getElementById('uploadBtn').classList.remove('d-none');
        };

        reader.readAsArrayBuffer(file);
    }

    function removeDuplicateRows(rows, headers) {
        const seen = new Set();

        return rows.filter(row => {
            const key = headers.map(h => row[h]).join('|');
            if (seen.has(key)) return false;
            seen.add(key);
            return true;
        });
    }

    function buildTable(headers, rows) {

        if (dataTable) {
            dataTable.destroy();
            $('#previewTable thead').empty();
            $('#previewTable tbody').empty();
        }

        // Header
        const thead = $('#previewTable thead');
        const headerRow = $('<tr/>');
        headers.forEach(h => headerRow.append(`<th>${h}</th>`));
        thead.append(headerRow);

        // Body
        const tbody = $('#previewTable tbody');
        rows.forEach(r => {
            const tr = $('<tr/>');
            headers.forEach(h => tr.append(`<td>${r[h]}</td>`));
            tbody.append(tr);
        });

        dataTable = $('#previewTable').DataTable({
            pageLength: 10,
            searching: true,
            ordering: true,
            scrollX: true,
            autoWidth: false
        });
    }

    function getAntiForgeryToken() {
        return document.querySelector(
            'input[name="__RequestVerificationToken"]'
        ).value;
    }


    async function uploadData() {
        const btn = document.getElementById('uploadBtn');

        // Disable button to prevent multiple clicks
        btn.disabled = true;

        // Save original text
        const originalText = btn.innerHTML;

        // Add spinning cog
        btn.innerHTML = `<i class="fas fa-cog fa-spin"></i> Uploading...`;
        const uploadType = document.getElementById('uploadtype').value;

        if (!uploadType) {
            alert('Please select an upload type');
            return;
        }

        const payload = {
            UploadType: parseInt(uploadType),
            Rows: extractedRows
        };

        const response = await fetch('/BulkUpload', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-TOKEN-HEADERNAME': getAntiForgeryToken()
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const result = await response.json();
            displayError(result.message);
            btn.innerHTML = originalText;
            btn.disabled = false;
            return;
        }

        alert("Upload Successful");

        btn.innerHTML = originalText;
        btn.disabled = false;
    }


    function onUploadTypeChanged(select) {
        const selectedValue = select.value;

        // Hide all templates
        document
            .querySelectorAll('.upload-template')
            .forEach(el => el.classList.add('d-none'));

        // Hide upload area by default
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.classList.add('d-none');

        if (!selectedValue) return;

        // Show selected template
        const template = document.querySelector(
            `.upload-template[data-upload="${selectedValue}"]`
        );

        if (template) {
            template.classList.remove('d-none');
        }

        // ✅ Show upload area
        uploadArea.classList.remove('d-none');

        // (Optional) Reset previous upload state
        document.getElementById('excelInput').value = '';
    }

    function displayError(error) {
        const alertDiv = document.getElementById("validationSummaryPP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        const li = document.createElement("li");
                li.textContent = error;
                li.className = 'fs-18';
                list.appendChild(li);

        // Show alert
        alertDiv.classList.remove("d-none");

        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function displayErrors(errors) {
        const alertDiv = document.getElementById("validationSummaryPP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        Object.keys(errors).forEach(field => {
            errors[field].forEach(message => {
                const li = document.createElement("li");
                li.textContent = message;
                li.className = 'fs-18';
                list.appendChild(li);
            });
        });

        // Show alert
        alertDiv.classList.remove("d-none");
        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
</script>