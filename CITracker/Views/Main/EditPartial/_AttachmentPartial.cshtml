<!-- Page Header Close -->
<div id="attachments_info" class="row row-sm d-none">
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-header justify-content-between">
                <div class="card-title"> Attachments </div>
            </div>
            <div class="card-body custom-scroll">
                <div id="validationSummaryAP" class="alert alert-danger d-none" role="alert">
                    <ul class="mb-0"></ul>
                </div>
                @Html.AntiForgeryToken()
                <nav class="navbar navbar-expand-lg bg-light">
                    <div class="container-fluid">
                        <a class="navbar-brand col-xl-6 col-lg-6 col-md-6 col-sm-6" href="">Comments</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Date</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Add/Remove</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href=""></a>
                    </div>
                </nav>
                <div class="attCardBody">

                    <!--Hidden form-->
                    <div class="row gy-4 mt-2 attBody mb-5 d-none" id="commentTemplate">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                            <textarea class="form-control" name="comment" rows="3"></textarea>
                            <input type="hidden" name="commentId" class="comment-id" value="0">
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                    <input type="text" class="form-control flatpickr-input date-input active" name="date" placeholder="Date" readonly="readonly">
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="mb-md-0 mb-2 ms-5">
                                <button class="btn btn-icon btn-primary btn-wave waves-effect waves-light addAtt"> <i class="fe fe-plus"></i> </button>
                                <button class="btn btn-icon btn-warning btn-wave me-5 waves-effect waves-light d-none removeAtt"> <i class="fe fe-minus"></i> </button>
                            </div>
                        </div>
                    </div>

                    <div class="row gy-4 attBody mt-2 mb-5">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                            <textarea class="form-control" name="comment" rows="3"></textarea>
                            <input type="hidden" name="commentId" class="comment-id" value="0">
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                    <input type="text" class="form-control flatpickr-input date-input active" name="date" placeholder="Date" readonly="readonly">
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="mb-md-0 mb-2 ms-5">
                                <button class="btn btn-icon btn-primary btn-wave waves-effect waves-light addAtt"> <i class="fe fe-plus"></i> </button>
                                <button class="btn btn-icon btn-warning btn-wave me-5 waves-effect waves-light d-none removeAtt"> <i class="fe fe-minus"></i> </button>
                            </div>
                        </div>
                    </div>
                </div>

                <nav class="navbar navbar-expand-lg bg-light mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand col-xl-3 col-lg-3 col-md-3 col-sm-3" href="">Category</a>
                        <a class="navbar-brand col-xl-6 col-lg-6 col-md-6 col-sm-6" href="">Item</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Attachment</a>
                    </div>
                </nav>

                <div id="contractRoot"></div>

                <div class="col-xl-12">
                    <div class="card custom-card">
                        <div class="card-body">
                            <label for="formFileLg" class="form-label">Final Report (Supported Format: PPT, Excel, PDF, Word)</label>
                            <input class="form-control form-control-lg" id="finalReport" type="file" onchange="uploadFinalReportFile(this)">
                        </div>
                    </div>
                </div>

            </div>
            <div class="card-footer border-top-card">
                <button class="btn btn-primary" onclick="loadPartial('attachments_info', 'tools_info')">Previous</button>
                <button class="btn btn-success shadow-success" onclick="UpdateCIProjectComment(this, 'attachments_info', 'financial_info')">Save &amp; Next</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.initialComments = @Html.Raw(Json.Serialize(Model.ProjectComment == null ? new List<Shared.Request.CICommentDTO>() : Model.ProjectComment));

        function initCommentRow(section, data = null) {

            const textarea  = section.querySelector('textarea[name="comment"]');
            const dateInput = section.querySelector('input[name="date"]');
            const idInput = section.querySelector('input[name="commentId"]');

            if (!textarea || !dateInput || !idInput) return;

            textarea.value  = data?.Comment ?? '';
            dateInput.value = data?.Date ?? '';
            idInput.value   = data?.Id ?? 0;

            // Initialize flatpickr ONLY on this input
            flatpickr(dateInput, {
                dateFormat: "Y-m-d",
                allowInput: false
            });
        }

        function createCommentBlock(data = null) {

            const newForm = $('#commentTemplate')
                .clone(false)
                .removeClass('d-none')
                .removeAttr('id')
                .addClass('attBody');

            // Toggle buttons
            newForm.find('.addAtt').addClass('d-none');
            newForm.find('.removeAtt').removeClass('d-none');

            $('.attCardBody').append(newForm);

            initCommentRow(newForm[0], data);
        }

        // ============================
        // Partial load handler
        // ============================
        document.addEventListener('partialShown', function (e) {

            const FILE_PREVIEW_MAP = {
                pdf: {
                    img: "../assets/images/files/png/2.png",
                    title: "PDF Document"
                },
                doc: {
                    img: "../assets/images/files/png/6.png",
                    title: "Word Document"
                },
                docx: {
                    img: "../assets/images/files/png/6.png",
                    title: "Word Document"
                },
                xlsx: {
                    img: "../assets/images/files/png/3.png",
                    title: "Excel Document"
                },
                csv: {
                    img: "../assets/images/files/png/3.png",
                    title: "Excel Document"
                }
            };

            // ----------------------------
            // Attachments tab logic
            // ----------------------------
            if (e.detail?.id === 'attachments_info') {
                // ----------------------------
                // File lock logic (unchanged)
                // ----------------------------
                applyFileLock(window.AppState.CIProject.Status);

                function applyFileLock(status) {
                    const fileInput = document.getElementById("finalReport");
                    if (!fileInput) return;

                    fileInput.disabled = status !== "COMPLETED";
                }


                fetch(`/GetSelectedTools?val=${window.AppState.CIProject.Id}`)
                    .then(r => {
                        if (!r.ok) throw new Error("Failed to fetch tools");
                        return r.json();
                    })
                    .then(data => populateToolDiv(data))
                    .catch(console.error);

                    
                // ----------------------------
                // 🔑 COMMENT HYDRATION LOGIC
                // ----------------------------
                const visibleRow = document.querySelector(
                    '.attBody:not(#commentTemplate)'
                );

                if (!visibleRow) return;

                if (window.initialComments.Comment.length > 0) {

                    // First comment → visible row
                    initCommentRow(visibleRow, window.initialComments.Comment[0]);

                    // Remaining → cloned rows
                    for (let i = 1; i < window.initialComments.Comment.length; i++) {
                        createCommentBlock(window.initialComments.Comment[i]);
                    }

                } else {
                    // Create mode
                    initCommentRow(visibleRow);
                }
            }            


            function buildFilePreviewHtml({ img, title }, fileSize, fileUrl) {
                return `
                    <div class="text-center">
                        <div class="file-manger-icon">
                            <a href="${fileUrl}" target="_blank">
                                <img src="${img}" alt="file" class="br-7" style="width:35px;height:35px">
                            </a>
                        </div>
                        <h6 class="mb-1 fw-medium mt-0">${title}</h6>
                        <span class="text-muted">${fileSize}</span>
                    </div>
                `;
            }


            function populateToolDiv(groups) {
                const root = document.getElementById("contractRoot");
                if (!root) return;

                root.innerHTML = '';

                Object.entries(groups).forEach(([phaseName, tools]) => {

                    const container = document.createElement("div");
                    container.className = "contract-container";
                    container.style.margin = "0.5rem 0";

                    container.innerHTML = `
                        <div class="phase-sidebar">
                            <div class="phase-title">
                                <h1 class="phase-title-text">${phaseName}</h1>
                            </div>
                        </div>
                    `;

                    const contentPanel = document.createElement("div");
                    contentPanel.className = "content-panel";

                    tools.forEach(tool => {
                        const section = document.createElement("div");
                        section.className = "content-section";

                        let uploadHtml = ``;

                        if (tool.url) {
                            const ext = tool.url.split('.').pop().toLowerCase();
                            const previewConfig = FILE_PREVIEW_MAP[ext];

                            if (previewConfig) {
                                uploadHtml = buildFilePreviewHtml(
                                    previewConfig,
                                    '',          // size optional (not usually known on load)
                                    tool.url
                                );
                            } else {
                                // fallback if extension is unknown
                                uploadHtml = `
                                    <a href="${tool.url}" target="_blank">View uploaded file</a>
                                `;
                            }
                        }
                        else{
                            uploadHtml = `
                            <input
                                class="form-control"
                                type="file"
                                name="file_${tool.id}"
                                data-tool-id="${tool.id}"
                                onchange="uploadToolFile(this, ${tool.id})">
                            `;
                        }

                        section.innerHTML = `
                            <div class="section-text">
                                <h4>${tool.name}</h4>
                            </div>
                            <div class="col-3 mb-3">
                                ${uploadHtml}
                            </div>
                        `;

                        contentPanel.appendChild(section);
                    });

                    container.appendChild(contentPanel);
                    root.appendChild(container);
                });
            }

            window.uploadToolFile = function (fileInput, toolId) {
                const file = fileInput.files[0];
                if (!file) return;

                const extension = file.name.split('.').pop().toLowerCase();
                const previewConfig = FILE_PREVIEW_MAP[extension];

                const formData = new FormData();
                formData.append("file", file);
                formData.append("toolId", toolId);
                formData.append("__RequestVerificationToken", getAntiForgeryToken());

                fetch("/UploadToolFile", {
                    method: "POST",
                    body: formData,
                    credentials: "same-origin"
                })
                .then(r => {
                    if (!r.ok) throw new Error("Upload failed");
                    return r.json();
                })
                .then(data => {
                    // ⬇️ Replace upload input with preview
                    if (!previewConfig) return;

                    const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2) + " MB";
                    const replacementHtml = buildFilePreviewHtml(
                        previewConfig,
                        fileSizeMB,
                        data.fileUrl
                    );

                    const uploadContainer = fileInput.closest('.col-3');
                    uploadContainer.innerHTML = replacementHtml;
                })
                .catch(console.error);
            };

        });

        // ============================
        // Add / Remove handlers
        // ============================
        $(document).on('click', '.addAtt', function (e) {
            e.preventDefault();
            createCommentBlock();
        });

        $(document).on('click', '.removeAtt', function (e) {
            e.preventDefault();

            if ($('.attBody').length > 1) {
                $(this).closest('.attBody').remove();
            }
        });


    function collectData() {
        const commenting = [];

        document.querySelectorAll('.attBody').forEach(section => {
            const comment = section.querySelector('textarea[name="comment"]')?.value;
            const date = section.querySelector('input[name="date"]')?.value;
            const id = section.querySelector('input[name="commentId"]')?.value;


            if (comment && comment.trim() !== '') {
                commenting.push({
                    Comment: comment.trim(),
                    Date: date,
                    Id: id
                });
            }
        });

        return commenting;
    }

    function uploadFinalReportFile (fileInput) {
        const file = fileInput.files[0];
        if (!file) return;

        const extension = file.name.split('.').pop().toLowerCase();
        const previewConfig = FILE_PREVIEW_MAP[extension];

        const formData = new FormData();
        formData.append("file", file);
        formData.append("projectId", window.AppState.CIProject.Id);
        formData.append("__RequestVerificationToken", getAntiForgeryToken());

        fetch("/UploadFinalReportFile", {
            method: "POST",
            body: formData,
            credentials: "same-origin"
        })
        .then(r => {
            if (!r.ok) throw new Error("Upload failed");
            return r.json();
        })
        .then(data => {
            // ⬇️ Replace upload input with preview
            if (!previewConfig) return;

            const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2) + " MB";
            const replacementHtml = buildFilePreviewHtml(
                previewConfig,
                fileSizeMB,
                data.fileUrl
            );

            const uploadContainer = fileInput.closest('.col-3');
            uploadContainer.innerHTML = replacementHtml;
        })
        .catch(console.error);
    };


    async function UpdateCIProjectComment(ref, hide, show) {
        ref.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
        ref.disabled = true;

        const commentData = collectData();
        const formData = new FormData();

        formData.append('__RequestVerificationToken', getAntiForgeryToken());

        if (window.AppState.CIProject !== null) {
            formData.append('ProjectId', window.AppState.CIProject.Id.toString());
        }

        // Append comments using index notation for model binding
        commentData.forEach((member, index) => {
            formData.append(`Comment[${index}].Comment`, member.Comment);
            formData.append(`Comment[${index}].Date`, member.Date);
            formData.append(`Comment[${index}].Id`, member.Id);
        });

        //// Validation
        // if (commentData.length === 0) {
        //     displayErrorAP('Please add at least one comment.');

        //     ref.innerHTML = 'Save &amp; Next';
        //     ref.disabled = false;
        //     return;
        // }

        const hasEmptyComment = commentData.some(member => !member.Comment || member.Comment.trim() === '');
        if (hasEmptyComment) {
            displayErrorAP('All comments are required.');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        const hasEmptyDate = commentData.some(member => !member.Date || member.Date.trim() === '');
        if (hasEmptyDate) {
            displayErrorAP('All comment dates are required.');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        try
        {
            const response = await fetch('/UpdateCIProjectComment', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });


            if (!response.ok) {
                const result = await response.json();
                displayErrorsAP(result.errors);
                ref.innerHTML = 'Save &amp; Next';
                ref.disabled = false;
                return;
            }

             $("#" + hide).addClass("d-none");
             $("#" + show).removeClass("d-none");

             document.dispatchEvent(
                 new CustomEvent('partialShown', { detail: { id: show } })
             );

        } catch (err) {
            console.error(err);
            displayErrorAP('An error occurred - '+ err);
        }
        ref.innerHTML = 'Save &amp; Next';
        ref.disabled = false;
    }


    function displayErrorAP(error) {
        const alertDiv = document.getElementById("validationSummaryAP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        const li = document.createElement("li");
                li.textContent = error;
                li.className = 'fs-18';
                list.appendChild(li);

        // Show alert
        alertDiv.classList.remove("d-none");

        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function displayErrorsAP(errors) {
        const alertDiv = document.getElementById("validationSummaryAP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        Object.keys(errors).forEach(field => {
            errors[field].forEach(message => {
                const li = document.createElement("li");
                li.textContent = message;
                li.className = 'fs-18';
                list.appendChild(li);
            });
        });

        // Show alert
        alertDiv.classList.remove("d-none");
        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
</script>