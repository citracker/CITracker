@using Shared.Enumerations
@inject IHttpContextAccessor hca
@model Shared.ViewModels.ContinuousImprovementVM

<!-- Page Header Close -->
<div id="project_info" class="row row-sm">
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-header justify-content-between">
                <div class="card-title"> Project Details </div>
            </div>
            <div class="card-body" style="min-height: 650px;height: 650px;overflow-y:scroll;">
                <div class="row gy-4">
                    <div id="validationSummaryPP" class="alert alert-danger d-none" role="alert">
                        <ul class="mb-0"></ul>
                    </div>
                    @{
                        var isAdminOrFacilitator = hca?.HttpContext?.Session?.GetString("UserRole") == "Admin" || Model.Project.FacilitatorId == Convert.ToInt64(hca?.HttpContext?.Session?.GetString("UserId"));
                    }
                    @Html.AntiForgeryToken()
                    <div class="col-xl-6 col-lg-6 col-md-6 col-sm-12">
                        <p class="mb-2 fw-medium">
                            Title <span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="A good title should be short and contain searchable words"> <i class="fe fe-info"></i></a>
                        </p>
                        <input type="text" class="form-control" id="title" name="title" placeholder="Project Title" value="@Model.Project.Title" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                        <input type="text" class="form-control" id="id" name="id" value="@Model.Project.Id" hidden>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="startdate" class="form-label">Start Date</label>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                <input type="text" class="form-control flatpickr-input active" id="startdate" name="startdate" placeholder="Start Date" value="@(Model.Project.StartDate.ToString("yyyy-MM-dd"))" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="enddate" class="form-label">End Date</label>
                        <div class="form-group">
                            <div class="input-group">
                                <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                <input type="text" class="form-control flatpickr-input active" id="enddate" name="enddate" placeholder="End Date" value="@(Model.Project.EndDate.ToString("yyyy-MM-dd"))" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                            </div>
                        </div>
                    </div>

                    <div class="col-xl-2 col-lg-2 col-md-2 col-sm-12">
                        <label for="priority" class="form-label">Priority<span style="color:red">*</span></label>
                        <select class="form-control" name="priority" id="priority" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                            <option value="High" @(Model.Project.Priority == "High" ? "selected" : "")>High</option>
                            <option value="Medium" @(Model.Project.Priority == "Medium" ? "selected" : "")>Medium</option>
                            <option value="Low" @(Model.Project.Priority == "Low" ? "selected" : "")>Low</option>
                        </select>
                    </div>

                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                        <p class="mb-2 fw-medium">
                            Business Objective Alignment <span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="Select the most appropriate objectives based on your business focus"> <i class="fe fe-info"></i></a>
                        </p>
                        <div class="card-body d-sm-flex justify-content-between">
                            <label class="form-check form-control m-2 p-2">
                                <input type="checkbox" value="Safety" name="boa" @(Model.Project.BusinessObjectiveAlignment.Contains("Safety") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label"> Safety </span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="checkbox" value="Sustainability" name="boa" @(Model.Project.BusinessObjectiveAlignment.Contains("Sustainability") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label"> Sustainability </span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="checkbox" value="Cost/Revenue" name="boa" @(Model.Project.BusinessObjectiveAlignment.Contains("Cost/Revenue") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label"> Cost/Revenue </span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="checkbox" value="Efficiency" name="boa" @(Model.Project.BusinessObjectiveAlignment.Contains("Efficiency") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label"> Efficiency </span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="checkbox" value="Customer Experience" name="boa" @(Model.Project.BusinessObjectiveAlignment.Contains("Customer Experience") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label"> Customer Experience </span>
                            </label>
                        </div>
                    </div>

                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                        <label for="problemstatement" class="form-label">
                            Problem Statement <span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="A good problem statement should contain - what, where, when and impact to the business."> <i class="fe fe-info"></i></a>
                        </label>
                        <textarea class="form-control" name="problemstatement" rows="4" @(isAdminOrFacilitator == true ? "" : "readonly") required>@Model.Project.ProblemStatement</textarea>
                    </div>

                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                        <p class="mb-2 fw-medium">
                            Methodology <span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="Select the most appropriate approach for executing the initiative/project."> <i class="fe fe-info"></i></a>
                        </p>
                        <div class="card-body d-sm-flex justify-content-between">
                            <label class="form-check form-control m-2 p-2">
                                <input type="radio" name="methodology" value="General" alt="DMAIC" onchange="onMethodologyChanged()" @(Model.Project.Methodology.Equals("DMAIC") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label">DMAIC</span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="radio" name="methodology" value="General" alt="Gemba Kaizen" onchange="onMethodologyChanged()" @(Model.Project.Methodology.Equals("Gemba Kaizen") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label">Gemba Kaizen</span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="radio" name="methodology" value="General" alt="JDI" onchange="onMethodologyChanged()" @(Model.Project.Methodology.Equals("JDI") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label">JDI</span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="radio" name="methodology" value="Project" alt="Project" onchange="onMethodologyChanged()" @(Model.Project.Methodology.Equals("Project") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label">Project</span>
                            </label>
                            <label class="form-check form-control m-2 p-2">
                                <input type="radio" name="methodology" value="General" alt="Others" onchange="onMethodologyChanged()" @(Model.Project.Methodology.Equals("Others") ? "checked" : "") @(isAdminOrFacilitator == true ? "" : "readonly")>
                                <span class="form-check-label">Others</span>
                            </label>
                        </div>
                    </div>

                    <div class="col-xl-12 col-lg-12 col-md-12 col-sm-12">
                        <p class="mb-2 fw-medium">
                            Working towards a certification? <span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="This helps with tying the initiative/project to any Lean 6 sigma certification effort"> <i class="fe fe-info"></i></a>
                        </p>
                        <div id="certificationContainer" class="card-body d-sm-flex justify-content-between"></div>
                        <input type="hidden" id="preselectedCertification" value="@Model.Project.Certification">
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="targetsavings" class="form-label">Total Expected Savings/Revenue</label>
                        <div class="input-group">
                            <input type="text" name="targetsavings" id="targetsavings" class="form-control" placeholder="Enter saving Amount" value="@Model.Project.TotalExpectedRevenue.ToString("N2")" @(isAdminOrFacilitator == true ? "" : "readonly") oninput="formatNumberRealTime(this)" onkeyup="formatNumberRealTime(this)" onkeypress="return (event.charCode >= 48 && event.charCode <= 57) || event.charCode == 8 || event.charCode == 0 || event.charCode == 13" oninput="this.value = this.value.replace(/[^0-9]/g, '')" onpaste="return false" required>
                            <button class="btn btn-outline-primary dropdown-toggle show" type="button" data-bs-toggle="dropdown" aria-expanded="true">@Model.Project.Currency</button>
                            <ul class="dropdown-menu dropdown-menu-end" style="position: absolute; inset: 0px 0px auto auto; margin: 0px; transform: translate(0px, 41px); min-width:auto; min-width:auto;" data-popper-placement="bottom-end">
                                <li><a class="dropdown-item currency-item" href="javascript:void(0);">&#8358;</a></li>
                                <li><a class="dropdown-item currency-item" href="javascript:void(0);">&#8364;</a></li>
                                <li><a class="dropdown-item currency-item" href="javascript:void(0);">&#163;</a></li>
                                <li><a class="dropdown-item currency-item" href="javascript:void(0);">&#36;</a></li>
                                <li><a class="dropdown-item currency-item" href="javascript:void(0);">&#165;</a></li>
                            </ul>
                        </div>
                        <input type="hidden" name="currency" id="selectedCurrency" value="@Model.Project.Currency">
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="status" class="form-label">
                            Status<span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="Select and modify the status as the initiative/project progress"> <i class="fe fe-info"></i></a>
                        </label>
                        <select class="form-control" name="status" id="status" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                            @{
                                var currentStatus = Model.Project.Status;
                                var isAdmin = hca?.HttpContext?.Session?.GetString("UserRole") == "Admin";
                            }

                            @foreach (Status item in Enum.GetValues(typeof(Status)))
                            {
                                if (item == Status.PROPOSED)
                                {
                                    continue;
                                }

                                <option value="@item" selected="@(currentStatus == item.ToString())">
                                    @item
                                </option>
                            }
                        </select>
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="phase" class="form-label">Phase</label>
                        <input type="hidden" id="savedPhaseId" value="@Model.Project.PhaseId" />
                        <select class="form-control" name="phase" id="phase">
                        </select>
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="country" class="form-label">Country<span style="color:red">*</span></label>
                        <select class="form-control" name="country" id="country" onchange="onCountryChange(this, 'facility')" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                            @if (Model.OrganizationCountry != null)
                            {
                                if (Model.OrganizationCountry.Any())
                                {
                                    foreach (var country in Model.OrganizationCountry)
                                    {
                                        if (Model.Project.CountryId == country.Id)
                                        {
                                            <option value="@country.Id" selected>@country.Country</option>
                                        }
                                        else
                                        {
                                            <option value="@country.Id">@country.Country</option>
                                        }
                                    }
                                }
                            }
                        </select>
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="facility" class="form-label">Facility</label>
                        <select class="form-control" name="facility" id="facility" onchange="onFacilityChange(this, 'department')" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                        </select>
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="department" class="form-label">
                            Department<span style="color:red">*</span>
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="Select functional groups that owns the project being improved"> <i class="fe fe-info"></i></a>
                        </label>
                        <select class="form-control" name="department" id="department" @(isAdminOrFacilitator == true ? "" : "readonly") required>
                        </select>
                    </div>

                    <div class="col-xl-3 col-lg-3 col-md-3 col-sm-12">
                        <label for="input-text" class="form-label">
                            Supporting Value Stream
                            <a href="javascript:void(0);" data-bs-toggle="tooltip" data-bs-custom-class="tooltip-primary" class="text-primary" data-bs-original-title="The name of the value stream this initiative is tied to"> <i class="fe fe-info"></i></a>
                        </label>
                        <select id="supportingvaluestrings" name="supportingvaluestrings" class="form-control" @(isAdminOrFacilitator == true ? "" : "readonly")>
                            @* <optgroup label="OPERATIONAL EXCELLENCE">
                                @foreach (var i in Model.OperationalExcellence)
                                {
                                    if (Model.Project.SupportingValueStream.Equals($"OE|{i.Id}"))
                                    {
                                        <option value="OE|@i.Id" selected>@i.Title</option>
                                    }
                                    else
                                    {
                                        <option value="OE|@i.Id">@i.Title</option>
                                    }
                                }
                            </optgroup>
                            <optgroup label="STRATEGIC INITIATIVES">
                                @foreach (var i in Model.StrategicInitiative)
                                {
                                    if (Model.Project.SupportingValueStream.Equals($"SI|{i.Id}"))
                                    {
                                        <option value="SI|@i.Id" selected>@i.Title</option>
                                    }
                                    else
                                    {
                                        <option value="SI|@i.Id">@i.Title</option>
                                    }
                                }
                            </optgroup> *@
                        </select>
                    </div>
                </div>
            </div>
            <div class="card-footer border-top-card">
                <button class="btn btn-success shadow-success" onclick="UpdateCIProject(this, 'project_info', 'team_info')">Save &amp; Next</button>
            </div>
        </div>
    </div>
</div>

<script>
    window.AppState = {
        selectedMethodology: null
    };
    window.preselectedProjectId = {
        id: '@Model.Project.SupportingValueStream'
    };
    const facilities = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OrganizationFacility));
    const departments = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OrganizationDepartment));
    const preSelectedFacilityId = @(Model.Project?.FacilityId);
    const preSelectedDepartmentId = @(Model.Project?.DepartmentId);

    document.addEventListener("DOMContentLoaded", function () {
        let endPicker;

        endPicker = flatpickr("#enddate", {
            dateFormat: "Y-m-d"
        });

        const startPicker = flatpickr("#startdate", {
            dateFormat: "Y-m-d",
            onChange: function (selectedDates) {
                if (selectedDates.length) {
                    const startDate = selectedDates[0];

                    // Set min date for end date
                    endPicker.set("minDate", startDate);

                    // Optional: auto-set end date to +12 months
                    const endDate = new Date(startDate);
                    endDate.setFullYear(endDate.getFullYear() + 1);
                    endPicker.setDate(endDate, true);
                }
            }
        });

        const $select = $('#supportingvaluestrings');

        function initSelect2() {
            $select.select2({
                placeholder: 'Kindly search for a project',
                minimumInputLength: 3,
                allowClear: true,
                ajax: {
                    url: '/SearchSupportingValues',
                    dataType: 'json',
                    delay: 3,
                    data: params => ({ search: params.term }),
                    processResults: data => {
                        const grouped = {};

                        data.forEach(item => {
                            if (!grouped[item.group]) {
                                grouped[item.group] = {
                                    text: item.group,
                                    children: []
                                };
                            }
                            grouped[item.group].children.push({
                                id: item.id,
                                text: item.text
                            });
                        });

                        return { results: Object.values(grouped) };
                    }
                }
            });
        }

        // ✅ If we have a preselected ID, resolve it first
        if (window.preselectedProjectId.id) {
            $.getJSON('/GetSupportingValueById', {
                id: window.preselectedProjectId.id
            })
            .done(function (item) {
                console.log(item)
                const option = new Option(item.text, item.id, true, true);
                $select.append(option).trigger('change');
                initSelect2();
            });
        } else {
            initSelect2();
        }
    });

    document.addEventListener('DOMContentLoaded', function () {

        const certOptions = {
            DMAIC: ['Green Belt', 'Black Belt', 'Not Applicable'],
            'Gemba Kaizen': ['Not Applicable'],
            JDI: ['Not Applicable'],
            Project: ['PMP'],
            Others: ['Not Applicable']
        };

        // Master list of ALL certifications
        const allCertifications = [
            'Green Belt',
            'Black Belt',
            'PMP',
            'Not Applicable'
        ];

        const container = document.getElementById('certificationContainer');

        // Render ALL certifications ONCE
        function renderAllCertifications() {
            container.innerHTML = '';

            allCertifications.forEach((text, index) => {
                container.insertAdjacentHTML('beforeend', `
                    <label class="form-check form-control m-2 p-2">
                        <input type="radio"
                               name="certification"
                               id="cert_${index}"
                               value="${text}"
                               disabled>
                        <span class="form-check-label" for="cert_${index}">
                            ${text}
                        </span>
                    </label>
                `);
            });
        }

        const preselectedCertification = document.getElementById('preselectedCertification')?.value;

        // Enable/disable based on selected methodology
        function updateCertifications(methodology) {
            const allowed = certOptions[methodology] || [];

            document.querySelectorAll('input[name="certification"]').forEach(radio => {
                    const isAllowed = allowed.includes(radio.value);

                    radio.disabled = !isAllowed;

                    if (!isAllowed) {
                        radio.checked = false;
                    }

                    if (isAllowed && preselectedCertification && radio.value === preselectedCertification) {
                        radio.checked = true;
                    }
                });
        }


        // Initial render
        renderAllCertifications();

        // 🔹 NEW: run update on page load if a methodology is already selected
        const preselectedMethodology = document.querySelector(
            'input[name="methodology"]:checked'
        );
        
        if (preselectedMethodology) {
            updateCertifications(preselectedMethodology.getAttribute("alt"));
            onMethodologyChanged()
        }

        // Methodology change handler
        document
            .querySelectorAll('input[name="methodology"]')
            .forEach(radio => {
                radio.addEventListener('change', function () {
                    updateCertifications(this.getAttribute("alt"));
                });
            });

    });

    document.addEventListener('DOMContentLoaded', function () {
        const countrySelect = document.getElementById('country');

        if (countrySelect && countrySelect.value) {
            onCountryChange(countrySelect, 'facility');
        }

        const facilitySelect = document.getElementById('facility');

        if (facilitySelect && facilitySelect.value) {
            onFacilityChange(facilitySelect, 'department');
        }
    });

    function onCountryChange(selectEl, targetInputId) {
        const countryId = parseInt(selectEl.value);
        const locationSelect = document.getElementById(targetInputId);

        // Clear existing options
        locationSelect.innerHTML = '<option selected disabled>Select a Facility</option>';

        if (isNaN(countryId)) return;

        const filtered = facilities.filter(l => l.OrganizationCountryId === countryId);

        filtered.forEach(item => {
            const option = document.createElement('option');
            option.value = item.Id;
            option.textContent = item.Facility;
            if (item.Id == preSelectedFacilityId){
                option.selected = true;
            }
            locationSelect.appendChild(option);
        });
    }

    function onFacilityChange(selectEl, targetInputId) {1   
        const facilityId = parseInt(selectEl.value);
        const locationSelect = document.getElementById(targetInputId);

        // Clear existing options
        locationSelect.innerHTML = '<option selected disabled>Select a Department</option>';

        if (isNaN(facilityId)) return;

        const filtered = departments.filter(l => l.OrganizationFacilityId === facilityId);

        filtered.forEach(item => {
            const option = document.createElement('option');
            option.value = item.Id;
            option.textContent = item.Department;
            if (item.Id == preSelectedDepartmentId){
                option.selected = true;
            }
            locationSelect.appendChild(option);
        });
    }

    function formatNumberRealTime(input) {
        let cursorPos = input.selectionStart;
        let formattedValue = input.value;
        let numbersOnly = formattedValue.replace(/[^\d.]/g, '');

        let parts = numbersOnly.split('.');
        if (parts.length > 2) {
            numbersOnly = parts[0] + '.' + parts.slice(1).join('');
        }

        if (parts[0].length > 0) {
            parts[0] = parseInt(parts[0] || '0', 10).toLocaleString('en-US');
        }

        formattedValue = parts.join('.');
        input.value = formattedValue;

        let newCursorPos = cursorPos + (formattedValue.length - input.value.length);
        input.setSelectionRange(newCursorPos, newCursorPos);
    }

    function onMethodologyChanged() {
        const selectedRadio = document.querySelector(
            'input[name="methodology"]:checked'
        );

        if (!selectedRadio) return;

        const methodology = selectedRadio.value;
        window.AppState = window.AppState || {};
        window.AppState.selectedMethodology = selectedRadio.getAttribute("alt");

        fetch(`/GetMethodologyPhases?val=${encodeURIComponent(methodology)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("Failed to fetch tools");
                }
                return response.json();
            })
            .then(data => populatePhaseSelect(data))
            .catch(error => displayError(error));
    }

    function populatePhaseSelect(tools) {
        const select = document.getElementById("phase");
        const savedPhaseId = document.getElementById("savedPhaseId")?.value;

        // Clear existing options
        select.innerHTML = '<option value="">-- Select Tool --</option>';

        tools.forEach(tool => {
            const option = document.createElement("option");
            option.value = tool.Id;      // must match JSON property
            option.textContent = tool.Phase;
            
            // 🔹 Auto-select previously saved value
            if (savedPhaseId && tool.Id.toString() === savedPhaseId.toString()) {
                option.selected = true;
            }

            select.appendChild(option);
        });
    }

    document.querySelectorAll('.currency-item').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();

            const currency = this.textContent.trim();

            // Update button display
            const button = this.closest('.input-group').querySelector('button');
            button.innerHTML = currency;

            // Store value for form submission
            document.getElementById('selectedCurrency').value = currency;
        });
    });

    function getAntiForgeryToken() {
        return document.querySelector(
            'input[name="__RequestVerificationToken"]'
        ).value;
    }

    function formatDateToMMDDYYYY(dateString) {
        const date = new Date(dateString);

        // Handle invalid dates
        if (isNaN(date.getTime())) {
            displayError('Invalid date:', dateString);
            return '';
        }

        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const year = date.getFullYear();

        return `${month}/${day}/${year}`;
    }

    async function UpdateCIProject(ref, hide, show) {
        ref.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
        ref.disabled = true;

        const boa = document.querySelectorAll('input[name="boa"]:checked');
        const boavalue = Array.from(boa).map(cb => cb.value).join(',');

        const method = document.querySelector('input[name="methodology"]:checked');
        const methodvalue = method ? method.getAttribute("alt") : null;

        const cert = document.querySelector('input[name="certification"]:checked');
        const certvalue = cert ? cert.value : null;

        const formData = new FormData();
        formData.append('__RequestVerificationToken', getAntiForgeryToken());

        // Append all your fields to FormData
        formData.append('Id', document.getElementById("id").value);
        formData.append('Title', document.getElementById("title").value);
        formData.append('StartDate', formatDateToMMDDYYYY(document.getElementById("startdate").value));
        formData.append('EndDate', formatDateToMMDDYYYY(document.getElementById("enddate").value));
        formData.append('Priority', document.getElementById("priority").value);
        formData.append('BusinessObjectiveAlignment', boavalue);
        formData.append('ProblemStatement', document.querySelector('[name="problemstatement"]').value);
        formData.append('Methodology', methodvalue);
        formData.append('Certification', certvalue);
        formData.append('TotalExpectedRevenue', document.getElementById("targetsavings").value.replace(/[^\d.-]/g, ''));
        formData.append('Currency', document.getElementById("selectedCurrency").value);
        formData.append('Status', document.getElementById("status").value);
        formData.append('Phase', document.getElementById("phase").value);
        formData.append('CountryId', document.getElementById("country").value);
        formData.append('FacilityId', document.getElementById("facility").value);
        formData.append('DepartmentId', document.getElementById("department").value);
        formData.append('SupportingValueStream', document.getElementById("supportingvaluestrings").value);

        try {
                const response = await fetch('/UpdateCIProject', {
                    method: 'POST',
                    credentials: 'same-origin',
                    body: formData
                });

                if (!response.ok) {
                    const result = await response.json();
                    displayErrors(result.errors);
                    ref.innerHTML = 'Save &amp; Next';
                    ref.disabled = false;
                    return;
                }

                const data = await response.json();

                document.getElementById("id").value = data.Id;

                window.AppState = window.AppState || {};
                window.AppState.CIProject = data;

                // if(data.Status !== 'INITIATED'){
                //     displayError('Project Saved, To enter team members, update status in the project details page to "Initiated".');
                // }
                // else{
                     $("#" + hide).addClass("d-none");
                     $("#" + show).removeClass("d-none");

                     document.dispatchEvent(
                         new CustomEvent('partialShown', { detail: { id: show } })
                     );
                // }
        }
        catch (err) {
            displayError('An error occurred '+ err);
        }
        ref.innerHTML = 'Save &amp; Next';
        ref.disabled = false;
    }

    function displayError(error) {
        const alertDiv = document.getElementById("validationSummaryPP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        const li = document.createElement("li");
                li.textContent = error;
                li.className = 'fs-18';
                list.appendChild(li);

        // Show alert
        alertDiv.classList.remove("d-none");

        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function displayErrors(errors) {
        const alertDiv = document.getElementById("validationSummaryPP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        Object.keys(errors).forEach(field => {
            errors[field].forEach(message => {
                const li = document.createElement("li");
                li.textContent = message;
                li.className = 'fs-18';
                list.appendChild(li);
            });
        });

        // Show alert
        alertDiv.classList.remove("d-none");
        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
</script>