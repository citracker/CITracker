@model Shared.ViewModels.ContinuousImprovementVM

<!-- Page Header Close -->
<div id="tools_info" class="row row-sm d-none">
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-header justify-content-between">
                <div class="card-title"> Tools </div>
            </div>
            <div class="card-body" style="min-height: 650px;height: 650px;overflow-y:scroll;">
                <div class="d-sm-flex d-block align-items-center flex-wrap justify-content-center"> 
                    <div class="mb-lg-0 mb-2"><h4 class="text-lg-center m-3"></h4></div>
                </div>
                <p>Note: You can download the sample templates for each from the Download Icon <i class="fe fe-download" style="--feather-size: 48px; --feather-color: green;"></i></p>
                <input type="file" id="toolUploadInput" accept=".doc,.docx" style="display:none" />
                @Html.AntiForgeryToken()
                <div id="toolDiv" class="card-body d-sm-flex justify-content-between" style="overflow-x: auto;">
                    
                </div>
            </div>
            <div class="card-footer border-top-card">
                <button class="btn btn-primary" onclick="loadPartial('tools_info', 'team_info')">Previous</button>
                <button class="btn btn-success shadow-success" onclick="CIProjectTools(this, 'tools_info', 'attachments_info')">Save &amp; Next</button>
            </div>
        </div>
    </div>
</div>
<script>
    document.addEventListener('partialShown', function (e) {
        if (e.detail.id === 'tools_info') {
            if(window.AppState.selectedMethodology !== undefined){
                fetch(`/GetMethodologyTools?val=${encodeURIComponent(window.AppState.selectedMethodology)}&pid=${encodeURIComponent(window.AppState.CIProject.Id)}`)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("Failed to fetch tools");
                        }
                        return response.json();
                    })
                    .then(data => populateToolDiv(data))
                    .catch(error => console.error(error));
            }
        }

        function populateToolDiv(groups) {
            const ddd = document.getElementById("toolDiv");

            // Clear existing options
            ddd.innerHTML = '';

            Object.entries(groups).forEach(([phase, tools]) => {
                ddd.appendChild(createPhaseCard(phase, tools));
            });
        }



        const phaseTooltips = {
            Define: 'Project definition and alignment.',
            Measure: 'Current state performance baseline.',
            Analyze: 'Identify causes of variation.',
            Improve: 'Develop, test and implement solutions.',
            Control: 'Sustain gains and scale.',
            'Concept & Initiation': 'Identify a business need, problem, or opportunity and brainstorm ways to meet this need, solve this problem or seize this opportunity.',
            'Definition & Planning': 'Break down the larger project into smaller tasks, build your team and prepare a schedule for the completion of assignments.',
            Execution: 'Track, organize team members, manage timelines and make sure the work is done according to the original plan.',
            'Performance & Control': 'Project performance and monitoring ensures that results align with the management plan.',
            'Project Closure': 'Provide financial deliverables, release project resources and determine the success of the project, evaluating what did and did not work with the project.'
        };

        const phaseColors = {
            Define: '#bd5050 !important',
            Measure: '#3b82f6 !important',
            Analyze: '#f59e0b !important',
            Improve: '#10b981 !important',
            Control: '#6366f1 !important',
            'Concept & Initiation': '#bd5050 !important',
            'Definition & Planning': '#3b82f6 !important',
            Execution: '#f59e0b !important',
            'Performance & Control': '#10b981 !important',
            'Project Closure': '#6366f1 !important'
        };

        function createPhaseCard(key, tools) {
            const outer = document.createElement('div');
            outer.className = 'form-control border-dark rounded';
            outer.style.padding = '0';

            const card = document.createElement('div');
            card.className = 'card custom-card';

            /* ---------- HEADER ---------- */
            const header = document.createElement('div');
            header.className = 'card-header d-flex justify-content-between align-items-center';
            header.style.backgroundColor = phaseColors[key] || '#6c757d';

            const titleWrapper = document.createElement('div');
            titleWrapper.className = 'd-flex align-items-center gap-2';

            const title = document.createElement('div');
            title.className = 'card-title mb-0';
            title.textContent = key;

            const infoLink = document.createElement('a');
            infoLink.href = 'javascript:void(0);';
            infoLink.className = 'text-primary';
            infoLink.setAttribute('data-bs-toggle', 'tooltip');
            infoLink.setAttribute('data-bs-custom-class', 'tooltip-primary');
            infoLink.setAttribute(
                'data-bs-original-title',
                phaseTooltips[key] || 'More information'
            );

            infoLink.innerHTML = '<i class="fe fe-info"></i>';

            titleWrapper.appendChild(title);
            titleWrapper.appendChild(infoLink);
            header.appendChild(titleWrapper);

            /* ---------- BODY ---------- */
            const body = document.createElement('div');
            body.className = 'card-body';
            body.style.padding = '0.5rem';

            tools.forEach((tool, index) => {
                body.appendChild(createToolRow(tool, index, key));
            });

            card.appendChild(header);
            card.appendChild(body);
            outer.appendChild(card);

            // 🔹 Initialize tooltip AFTER DOM insertion
            setTimeout(() => {
                new bootstrap.Tooltip(infoLink);
            });

            return outer;
        }

        function createToolRow(tool, index, phase) {
            const row = document.createElement('div');
            row.className = 'form-check form-check-lg mt-3';
            row.style.display = 'flex';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'form-check-input';
            checkbox.name = 'toolbox';
            checkbox.id = `${phase}-${index}`;
            checkbox.value = `${phase}-${tool.id}`;
            
            checkbox.checked = !!tool.ischecked;

            const label = document.createElement('label');
            label.className = 'form-check-label me-3';
            label.setAttribute('for', checkbox.id);
            label.style.cssText = 'width:85%;max-width:85%';
            label.textContent = tool.name;

            const action = document.createElement('a');

            if (tool.url) {
                action.href = tool.url;
                action.target = '_blank';
                action.innerHTML =
                    '<i class="las la-download la-2x text-success"></i>';
            } else {
                action.innerHTML =
                    '<i class="las la-file-upload la-2x text-warning"></i>';

                action.addEventListener('click', function () {
                    triggerUpload(tool);
                });
            }

            row.appendChild(checkbox);
            row.appendChild(label);
            row.appendChild(action);

            return row;
        }
    });

    async function CIProjectTools(ref, hide, show) {
        ref.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
        ref.disabled = true;

        const tool = document.querySelectorAll('input[name="toolbox"]:checked');
        const toolvalue = Array.from(tool).map(cb => cb.value).join('||');


        const formData = new FormData();

        formData.append('__RequestVerificationToken', getAntiForgeryToken());

        if (window.AppState.CIProject !== null) {
            formData.append('ProjectId', window.AppState.CIProject.Id.toString());
        }

        if (window.AppState.selectedMethodology !== null) {
            formData.append('Methodology', window.AppState.selectedMethodology.toString());
        }

        formData.append('Tool', toolvalue);

        // Validation
        if (toolvalue.length === 0) {
            displayErrors('Please add at least one tool');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        try
        {
            const response = await fetch('/NewCIProjectTool', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });

            if (!response.ok) {
                const result = await response.json();
                displayErrors(result.errors);
                ref.innerHTML = 'Save &amp; Next';
                ref.disabled = false;
                return;
            }

            $("#" + hide).addClass("d-none");
            $("#" + show).removeClass("d-none");

            document.dispatchEvent(
                new CustomEvent('partialShown', { detail: { id: show } })
            );

        } catch (err) {
            console.error(err);
            alert('An error occurred');
        }
        ref.innerHTML = 'Save &amp; Next';
        ref.disabled = false;
    }

</script>