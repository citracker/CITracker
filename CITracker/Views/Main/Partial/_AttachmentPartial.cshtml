@model Shared.ViewModels.ContinuousImprovementVM

<!-- Page Header Close -->
<div id="attachments_info" class="row row-sm d-none">
    <div class="col-xl-12">
        <div class="card custom-card">
            <div class="card-header justify-content-between">
                <div class="card-title"> Attachments </div>
            </div>
            <div class="card-body" style="min-height: 650px;height: 650px;overflow-y:scroll;">
                <div id="validationSummaryAP" class="alert alert-danger d-none" role="alert">
                    <ul class="mb-0"></ul>
                </div>
                @Html.AntiForgeryToken()
                <nav class="navbar navbar-expand-lg bg-light"> 
                    <div class="container-fluid"> 
                        <a class="navbar-brand col-xl-6 col-lg-6 col-md-6 col-sm-6" href="">Comments</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Date</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Add/Remove</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href=""></a>
                    </div>
                </nav>
                <div class="attCardBody">

                    <!--Hidden form-->
                    <div class="row gy-4 mt-2 attBody mb-5 d-none" id="commentTemplate">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                            <textarea class="form-control" name="comment" rows="3"></textarea>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                    <input type="text" class="form-control flatpickr-input date-input active" name="date" placeholder="Date" readonly="readonly">
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="mb-md-0 mb-2 ms-5">
                                <button class="btn btn-icon btn-primary btn-wave waves-effect waves-light addAtt"> <i class="fe fe-plus"></i> </button>
                                <button class="btn btn-icon btn-warning btn-wave me-5 waves-effect waves-light d-none removeAtt"> <i class="fe fe-minus"></i> </button>
                            </div>
                        </div>
                    </div>

                    <div class="row gy-4 attBody mt-2 mb-5">
                        <div class="col-xl-6 col-lg-6 col-md-6 col-sm-6">
                            <textarea class="form-control" name="comment" rows="3"></textarea>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="form-group">
                                <div class="input-group">
                                    <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                    <input type="text" class="form-control flatpickr-input date-input active" name="date" placeholder="Date" readonly="readonly">
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-2 col-lg-2 col-md-2 col-sm-2">
                            <div class="mb-md-0 mb-2 ms-5">
                                <button class="btn btn-icon btn-primary btn-wave waves-effect waves-light addAtt"> <i class="fe fe-plus"></i> </button>
                                <button class="btn btn-icon btn-warning btn-wave me-5 waves-effect waves-light d-none removeAtt"> <i class="fe fe-minus"></i> </button>
                            </div>
                        </div>
                    </div>
                </div>

                <nav class="navbar navbar-expand-lg bg-light mb-4">
                    <div class="container-fluid">
                        <a class="navbar-brand col-xl-3 col-lg-3 col-md-3 col-sm-3" href="">Category</a>
                        <a class="navbar-brand col-xl-6 col-lg-6 col-md-6 col-sm-6" href="">Item</a>
                        <a class="navbar-brand col-xl-2 col-lg-2 col-md-2 col-sm-2" href="">Attachment</a>
                    </div>
                </nav>

                <div id="contractRoot"></div>

                <div class="col-xl-12">
                    <div class="card custom-card">
                        <div class="card-body">
                            <label for="formFileLg" class="form-label">Final Report (Supported Format: PPT, Excel, PDF, Word)</label>
                            <input class="form-control form-control-lg" id="finalReport" type="file" > 
                        </div>
                    </div>
                </div>

            </div>
            <div class="card-footer border-top-card">
                <button class="btn btn-primary" onclick="loadPartial('attachments_info', 'tools_info')">Previous</button>
                <button class="btn btn-success shadow-success" onclick="CIProjectComment(this, 'attachments_info', 'financial_info')">Save &amp; Next</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('partialShown', function (e) {

        applyFileLock(window.AppState.CIProject.Status);

        flatpickr(".date-input", {
            dateFormat: "Y-m-d"
        });

        if (e.detail.id === 'attachments_info') {
            fetch(`/GetSelectedTools?val=${window.AppState.CIProject.Id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch tools");
                    }
                    return response.json();
                })
                .then(data => populateToolDiv(data))
                .catch(error => console.error(error));
        }

        function populateToolDiv(groups) {
            const root = document.getElementById("contractRoot");

            Object.entries(groups).forEach(([phaseName, tools]) => {

                const container = document.createElement("div");
                container.className = "contract-container";
                container.style = "margin: 0.5rem 0";

                /* Sidebar */
                container.innerHTML = `
                    <div class="phase-sidebar">
                        <div class="phase-title">
                            <h1 class="phase-title-text">${phaseName}</h1>
                        </div>
                    </div>
                `;

                const contentPanel = document.createElement("div");
                contentPanel.className = "content-panel";

                tools.forEach(tool => {
                    const section = document.createElement("div");
                    section.className = "content-section";

                    let uploadHtml = `
                        <input
                            class="form-control"
                            type="file"
                            data-tool-id="${tool.id}"
                            name="file_${tool.id}"
                            onchange="uploadToolFile(this, ${tool.id})"
                        >
                    `;

                    if (tool.url) {
                        uploadHtml += `
                            <div class="mt-2">
                                <a href="${tool.url}" target="_blank" class="text-decoration-underline">
                                    View existing file
                                </a>
                            </div>
                        `;
                    }

                    section.innerHTML = `
                        <div class="section-text">
                            <h4 class="section-heading">${tool.name}</h4>
                        </div>
                        <div class="col-3 mb-3">
                            ${uploadHtml}
                        </div>
                    `;

                    contentPanel.appendChild(section);
                });

                container.appendChild(contentPanel);
                root.appendChild(container);
            });
        }

        function uploadToolFile(fileInput, toolId) {
            const file = fileInput.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append("file", file);
            formData.append("toolId", toolId);
            formData.append('__RequestVerificationToken', getAntiForgeryToken());

            fetch("/UploadToolFile", {
                method: "POST",
                body: formData,
                credentials: "same-origin"
            })
            .then(res => {
                if (!res.ok) throw new Error("Upload failed");
                return res.json();
            })
            .then(data => {
                console.log("Uploaded:", data.fileUrl);
            })
            .catch(err => {
                console.error(err);
            });
        }

        function applyFileLock(status) {
            const fileInput = document.getElementById("finalReport");

            if (status !== "COMPLETED") {
                fileInput.disabled = true;
            } else {
                fileInput.disabled = false;
            }
        }

    });

    $(document).on('click', '.removeAtt', function (e) {
        e.preventDefault();
        $(this).closest('.attBody').remove();
    });

    let formCount = 1;

    $(document).on('click', '.addAtt', function (e) {
        e.preventDefault();

        const newForm = $('#commentTemplate')
            .clone(false)
            .removeClass('d-none')
            .removeAttr('id')
            .addClass('attBody');

        // Toggle buttons
        newForm.find('.addAtt').addClass('d-none');
        newForm.find('.removeAtt').removeClass('d-none');

        // Clear values
        newForm.find('textarea').val('');
        newForm.find('input').val('');

        $('.attCardBody').append(newForm);

        // 🔑 Re-initialize flatpickr on the cloned input
        newForm.find('.date-input').flatpickr({
            dateFormat: "Y-m-d"
        });
    });


    function collectData() {
        const commenting = [];

        document.querySelectorAll('.attBody').forEach(section => {
            const comment = section.querySelector('textarea[name="comment"]')?.value;
            const date = section.querySelector('input[name="date"]')?.value;


            if (comment && comment.trim() !== '') {
                commenting.push({
                    Comment: comment.trim(),
                    Date: date
                });
            }
        });

        return commenting;
    }


    async function CIProjectComment(ref, hide, show) {
        ref.innerHTML = '<i class="fas fa-cog fa-spin"></i>';
        ref.disabled = true;

        const commentData = collectData();
        const formData = new FormData();

        formData.append('__RequestVerificationToken', getAntiForgeryToken());

        if (window.AppState.CIProject !== null) {
            formData.append('ProjectId', window.AppState.CIProject.Id.toString());
        }

        // Append comments using index notation for model binding
        commentData.forEach((member, index) => {
            formData.append(`Comment[${index}].Comment`, member.Comment);
            formData.append(`Comment[${index}].Date`, member.Date);
        });

        // Validation
        if (commentData.length === 0) {
            displayErrorAP('Please add at least one comment.');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        const hasEmptyComment = commentData.some(member => !member.Comment || member.Comment.trim() === '');
        if (hasEmptyComment) {
            displayErrorAP('All comments are required.');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        const hasEmptyDate = commentData.some(member => !member.Date || member.Date.trim() === '');
        if (hasEmptyDate) {
            displayErrorAP('All comment dates are required.');

            ref.innerHTML = 'Save &amp; Next';
            ref.disabled = false;
            return;
        }

        try
        {
            const response = await fetch('/NewCIProjectComment', {
                method: 'POST',
                credentials: 'same-origin',
                body: formData
            });


            if (!response.ok) {
                const result = await response.json();
                displayErrorsAP(result.errors);
                ref.innerHTML = 'Save &amp; Next';
                ref.disabled = false;
                return;
            }

            $("#" + hide).addClass("d-none");
            $("#" + show).removeClass("d-none");

            document.dispatchEvent(
                new CustomEvent('partialShown', { detail: { id: show } })
            );

        } catch (err) {
            console.error(err);
            displayErrorAP('An error occurred - '+ err);
        }
        ref.innerHTML = 'Save &amp; Next';
        ref.disabled = false;
    }


    function displayErrorAP(error) {
        const alertDiv = document.getElementById("validationSummaryAP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        const li = document.createElement("li");
                li.textContent = error;
                list.appendChild(li);

        // Show alert
        alertDiv.classList.remove("d-none");

        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }

    function displayErrorsAP(errors) {
        const alertDiv = document.getElementById("validationSummaryAP");
        const list = alertDiv.querySelector("ul");

        // Clear previous errors
        list.innerHTML = "";

        Object.keys(errors).forEach(field => {
            errors[field].forEach(message => {
                const li = document.createElement("li");
                li.textContent = message;
                list.appendChild(li);
            });
        });

        // Show alert
        alertDiv.classList.remove("d-none");
        const div = document.querySelector('.card-body');
        // For smooth scroll inside div
        div.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    }
</script>