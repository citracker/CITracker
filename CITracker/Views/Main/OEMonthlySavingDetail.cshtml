@model Shared.DTO.OperationalExcellenceMonthlySavingDTO

@{
    ViewData["Title"] = "CI Tracker";
    ViewData["Base"] = "InitiativeManagement";
    ViewData["Active"] = "OEMonthlySavingDetail";
    Layout = "~/Views/Shared/_MainLayout.cshtml";
}

<!--APP-CONTENT START-->
<div class="main-content app-content">
    <div class="container-fluid">
        <!-- Page Header -->
        <div class="d-md-flex d-block align-items-center justify-content-between page-header-breadcrumb">
            <div>
                <h2 class="main-content-title fs-24 mb-1">Monthly Savings</h2>
                <ol class="breadcrumb mb-0">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">Operational Excellence</a></li>
                    <li class="breadcrumb-item active" aria-current="page">{Operational Excellence Title}</li>
                </ol>
            </div>
        </div>
        <!-- Page Header Close -->
        <!-- Page Header Close -->
        <div id="project_info" class="row row-sm">
            <div class="col-xl-12">
                <div class="card custom-card">
                    <div class="card-header justify-content-between">
                        <div class="card-title"> Monthly Savings</div>
                    </div>
                    @using (Html.BeginForm("UpdateOEProjectMonthlySavings", "Main", FormMethod.Post))
                    {
                        @Html.AntiForgeryToken()
                        <div class="card-body">
                            <div class="row gy-4">

                                <div class="col-xl-2 col-lg-2 col-md-2 col-sm-12">
                                    <label for="input-text" class="form-label">Choose Month of Year<span style="color:red">*</span></label>
                                    <div class="form-group">
                                        <div class="input-group">
                                            <div class="input-group-text text-muted"> <i class="ri-calendar-line"></i> </div>
                                            <input type="text" class="form-control flatpickr-input active" id="monthyear" name="monthyear" value="@(Convert.ToDateTime(Model.MonthYear).ToString("MMMM yyyy"))" placeholder="Month & Year" readonly="readonly" required>
                                            <input type="text" class="form-control" name="msid" value="@Model.Id" hidden required>
                                            <input type="text" class="form-control" name="pjid" value="@Model.ProjectId" hidden required>
                                            <input type="text" class="form-control" name="orgid" value="@Model.OrganizationId" hidden required>
                                        </div>
                                    </div>
                                </div>

                                <div class="col-xl-4 col-lg-4 col-md-4 col-sm-12">
                                    <label for="savings" class="form-label">Savings<span style="color:red">*</span></label>
                                    <div class="input-group">
                                        <input type="text" name="savings" id="savings" class="form-control" placeholder="Enter saving amount" value="@Model.Savings.ToString("N2")" oninput="formatNumberRealTime(this)" onpaste="return false" inputmode="decimal" required>
                                        <button id="currencyBtn" class="btn btn-outline-primary dropdown-toggle show" type="button" data-bs-toggle="dropdown" aria-expanded="true">&#36;</button>
                                        <ul class="dropdown-menu dropdown-menu-end" style="position: absolute; inset: 0px 0px auto auto; margin: 0px; transform: translate(0px, 41px);" data-popper-placement="bottom-end">
                                            <li><a class="dropdown-item currency-item" data-value="₦" href="#">&#8358;</a></li>
                                            <li><a class="dropdown-item currency-item" data-value="€" href="#">&#8364;</a></li>
                                            <li><a class="dropdown-item currency-item" data-value="£" href="#">&#163;</a></li>
                                            <li><a class="dropdown-item currency-item" data-value="$" href="#">&#36;</a></li>
                                            <li><a class="dropdown-item currency-item" data-value="¥" href="#">&#165;</a></li>
                                        </ul>
                                    </div>
                                    <input type="hidden" name="currency" id="selectedCurrency" value="@Model.Currency">
                                </div>
                            </div>
                        </div>
                        <div class="card-footer border-top-card">
                            <button type="submit" class="btn btn-success shadow-success">Submit</button>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>
<!--APP-CONTENT CLOSE-->
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        const maxMonthYear = new Date(today.getFullYear(), today.getMonth(), 1);

        var mthyr = flatpickr("#monthyear", {
            dateFormat: "F Y",
            altInput: true,
            altFormat: "F Y",
            plugins: [
                new monthSelectPlugin({
                    shorthand: false,   // Jan vs January
                    dateFormat: "F Y",
                    altFormat: "F Y"
                })
            ]
        });

        // Set max date for end date
        mthyr.set("maxDate", maxMonthYear);
    });

    document.querySelectorAll('.currency-item').forEach(item => {
        item.addEventListener('click', function (e) {
            e.preventDefault();

            const currency = this.textContent.trim();

            // Update button display
            const button = this.closest('.input-group').querySelector('button');
            button.innerHTML = currency;

            // Store value for form submission
            document.getElementById('selectedCurrency').value = currency;
        });
    });

    function formatNumberRealTime(input) {
        let cursorPos = input.selectionStart;
        let formattedValue = input.value;
        let numbersOnly = formattedValue.replace(/[^\d.]/g, '');

        let parts = numbersOnly.split('.');
        if (parts.length > 2) {
            numbersOnly = parts[0] + '.' + parts.slice(1).join('');
        }

        if (parts[0].length > 0) {
            parts[0] = parseInt(parts[0] || '0', 10).toLocaleString('en-US');
        }

        formattedValue = parts.join('.');
        input.value = formattedValue;

        let newCursorPos = cursorPos + (formattedValue.length - input.value.length);
        input.setSelectionRange(newCursorPos, newCursorPos);
    }
</script>